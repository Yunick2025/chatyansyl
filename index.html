<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Musi-Sports Social</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"
    ></script>
    <style>
      :root {
        --primary: #ff7b00;
        --secondary: #00c3ff;
        --bg: #0a0e17;
        --bg-color: #0a0e17;
        --panel-bg: rgba(0, 0, 0, 0.8);
        --text-color: #ffffff;
        --input-bg: rgba(0, 0, 0, 0.3);
        --my-msg-bg: linear-gradient(135deg, var(--primary), #ff4000);
        --other-msg-bg: rgba(255, 255, 255, 0.1);
        --chat-bg-image: url("background.jpg");
        --overlay-opacity: 0.9;
      }

      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
      }

      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        overflow: hidden;
        transition: background 0.3s;
      }
      #bg-layer {
        position: absolute;
        inset: 0;
        background: url("background.jpg") center/cover;
        filter: blur(20px) brightness(0.3);
        z-index: -1;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
      }
      .card,
      .auth-container {
        background: var(--panel-bg);
        color: var(--text-color);
        padding: 30px;
        border-radius: 20px;
        border: 1px solid rgba(128, 128, 128, 0.2);
        text-align: center;
        width: 300px;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        background: var(--input-bg);
        border: 1px solid rgba(128, 128, 128, 0.3);
        color: var(--text-color);
        border-radius: 8px;
        outline: none;
        box-sizing: border-box;
      }
      input[type="color"] {
        padding: 0;
        height: 40px;
        cursor: pointer;
      }
      button {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        margin-top: 5px;
        transition: 0.3s;
      }
      .btn-main {
        background: var(--primary);
        color: white;
      }
      .btn-blue {
        background: var(--secondary);
        color: black;
      }
      .btn-danger {
        background: #ff4444;
        color: white;
      }
      .btn-grey {
        background: #555;
        color: white;
      }
      .btn-sec {
        background: transparent;
        border: 1px solid var(--secondary);
        color: var(--secondary);
      }

      #app {
        display: none;
        width: 100%;
        height: 100%;
        grid-template-columns: 260px 1fr;
      }
      #sidebar {
        background: var(--panel-bg);
        border-right: 1px solid rgba(128, 128, 128, 0.1);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      #sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        min-height: 0;
      }
      #sidebar-footer {
        padding: 15px;
        border-top: 1px solid rgba(128, 128, 128, 0.1);
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .user-item {
        padding: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        border-radius: 8px;
        transition: 0.2s;
        margin-bottom: 2px;
        font-size: 0.9em;
        overflow: hidden;
      }
      .user-item:hover {
        background: rgba(128, 128, 128, 0.1);
      }
      .user-avatar-small {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 8px;
        background: #888;
        flex-shrink: 0;
      }
      .user-name-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-left: 5px;
        flex-shrink: 0;
      }
      .online {
        background: #00ff88;
        box-shadow: 0 0 5px #00ff88;
      }
      .offline {
        background: #ff4444;
        opacity: 0.5;
      }

      /* STYLE DU BADGE DE NOTIFICATION */
      .badge {
        background: #ff4444;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 0.75em;
        margin-left: auto;
        font-weight: bold;
        min-width: 15px;
        text-align: center;
        box-shadow: 0 0 5px #ff4444;
        animation: bounce 0.5s;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }

      #chat-area {
        display: flex;
        flex-direction: column;
        position: relative;
        height: 100vh;
      }
      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        gap: 12px;
        display: flex;
        flex-direction: column;
        min-height: 0;
        background-color: var(--bg-color);
        background-image: linear-gradient(
            rgba(0, 0, 0, var(--overlay-opacity)),
            rgba(0, 0, 0, var(--overlay-opacity))
          ),
          var(--chat-bg-image);
        background-repeat: no-repeat;
        background-position: center;
        background-size: cover;
        background-attachment: fixed;
        background-blend-mode: overlay;
      }
      .main-input-zone {
        padding: 20px;
        background: var(--panel-bg);
        border-top: 1px solid rgba(128, 128, 128, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
        position: relative;
      }
      .main-input-zone input {
        margin: 0;
        border-radius: 30px;
        background: var(--input-bg);
        color: var(--text-color);
      }

      .msg {
        padding: 12px 18px;
        border-radius: 18px;
        max-width: 75%;
        font-size: 0.95em;
        position: relative;
        display: flex;
        flex-direction: column;
        color: white;
      }
      .me {
        align-self: flex-end;
        background: var(--my-msg-bg);
        border-bottom-right-radius: 2px;
      }
      .other {
        align-self: flex-start;
        background: var(--other-msg-bg);
        backdrop-filter: blur(10px);
        border-bottom-left-radius: 2px;
        border: 1px solid rgba(128, 128, 128, 0.2);
        color: var(--text-color);
      }
      .msg-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 4px;
        font-size: 0.8em;
      }
      .msg-time {
        font-size: 0.85em;
        opacity: 0.7;
      }
      .audio-msg {
        width: 240px;
        height: 40px;
        margin-top: 5px;
      }
      .img-msg {
        max-width: 250px;
        max-height: 300px;
        border-radius: 10px;
        margin-top: 5px;
        cursor: pointer;
        display: block;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .admin-del {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ff0000;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 0.8em;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        z-index: 10;
      }

      #lightbox {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 6000;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      #lightbox-img {
        max-width: 90%;
        max-height: 85%;
        border-radius: 5px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }
      .close-lightbox {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 2em;
        cursor: pointer;
      }

      emoji-picker {
        position: absolute;
        bottom: 80px;
        left: 20px;
        z-index: 2000;
        --background: #1a1f2e;
        --border-color: #333;
        display: none;
      }
      emoji-picker.show {
        display: block;
      }

      #private-area {
        position: fixed;
        bottom: 0;
        right: 20px;
        display: flex;
        gap: 15px;
        pointer-events: none;
        z-index: 1000;
      }
      .win {
        width: 320px;
        background: var(--panel-bg);
        color: var(--text-color);
        border-radius: 15px 15px 0 0;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        border: 1px solid rgba(128, 128, 128, 0.2);
      }
      .win.fullscreen {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 3000;
        border-radius: 0;
      }
      .head {
        padding: 12px;
        background: var(--secondary);
        color: #000;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .body {
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        background: rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .win.fullscreen .body {
        flex: 1;
      }
      .minimized .body,
      .minimized .private-input-zone {
        display: none;
      }
      .private-input-zone {
        display: flex;
        padding: 8px;
        background: var(--panel-bg);
        border-top: 1px solid rgba(128, 128, 128, 0.2);
        align-items: center;
        gap: 5px;
      }
      .private-input-zone input {
        flex: 1;
        margin: 0;
        border-radius: 20px;
        padding: 10px;
        background: var(--input-bg);
        color: var(--text-color);
        border: none;
      }
      .icon-btn {
        background: none;
        border: none;
        color: var(--secondary);
        font-size: 1.1em;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .icon-btn:hover {
        background: rgba(128, 128, 128, 0.2);
      }
      .icon-btn.recording {
        color: #ff4444;
        background: rgba(255, 68, 68, 0.2);
        animation: pulse 0.5s infinite;
      }

      .profile-pic-big {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--secondary);
        margin: 0 auto 15px;
        display: block;
        background: #333;
      }
      .profile-info {
        font-size: 0.9em;
        opacity: 0.8;
        margin-bottom: 20px;
        line-height: 1.6;
      }
      .avatar-grid {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 10px 0;
        flex-wrap: wrap;
      }
      .avatar-option {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        object-fit: cover;
      }
      .avatar-option.selected {
        border-color: var(--primary);
        transform: scale(1.1);
      }

      .on-call {
        background: #2ecc71 !important;
        color: white !important;
      }
      .radio-player {
        background: linear-gradient(45deg, #1e293b, #0f172a);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
      }

      #video-overlay {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 5000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #remote-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      #local-video {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 150px;
        height: 100px;
        background: #333;
        border: 2px solid var(--secondary);
        border-radius: 10px;
        object-fit: cover;
        z-index: 5001;
      }
      .video-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        background: rgba(0, 0, 0, 0.5);
        padding: 15px;
        border-radius: 30px;
        backdrop-filter: blur(10px);
      }
      .v-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: 0.3s;
      }
      .v-btn.red {
        background: #ff4444;
      }
      .v-btn.grey {
        background: rgba(255, 255, 255, 0.2);
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div id="bg-layer"></div>
    <audio id="remote-audio" autoplay></audio>
    <audio
      id="notif-sound"
      src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
    ></audio>

    <div id="lightbox" onclick="closeImage()">
      <span class="close-lightbox">&times;</span>
      <img id="lightbox-img" />
    </div>

    <div id="video-overlay">
      <video id="remote-video" autoplay playsinline></video>
      <video id="local-video" autoplay playsinline muted></video>
      <div class="video-controls">
        <button class="v-btn grey" onclick="toggleMic()">
          <i class="fas fa-microphone"></i>
        </button>
        <button class="v-btn grey" onclick="toggleCam()">
          <i class="fas fa-video"></i>
        </button>
        <button
          class="v-btn red"
          onclick="endCall(); socket.emit('hang-up', {to: activeCallUser})"
        >
          <i class="fas fa-phone-slash"></i>
        </button>
      </div>
    </div>

    <!-- AUTH -->
    <div id="auth-screen" class="modal-overlay">
      <div id="login-form" class="auth-container">
        <h1 style="color: var(--primary)">MUSI-SPORTS</h1>
        <input id="login-u" placeholder="Pseudo" />
        <input id="login-p" type="password" placeholder="Mot de passe" />
        <button onclick="login()" class="btn-main">SE CONNECTER</button>
        <div style="margin-top: 20px; font-size: 0.8em">
          Pas encore de compte ?
        </div>
        <button onclick="toggleAuth(true)" class="btn-sec">
          CR√âER UN COMPTE
        </button>
        <p
          id="login-err"
          style="color: #ff4444; font-size: 0.8em; margin-top: 15px"
        ></p>
      </div>
      <div id="register-form" class="auth-container" style="display: none">
        <h2 style="color: var(--secondary)">Inscription</h2>
        <div class="form-group">
          <input id="reg-u" placeholder="Choisir un Pseudo" /><input
            id="reg-p"
            type="password"
            placeholder="Mot de passe"
          />
        </div>
        <div class="form-group" style="display: flex; gap: 10px">
          <input
            id="reg-age"
            type="number"
            placeholder="√Çge"
            style="width: 80px"
          /><select id="reg-sex">
            <option value="">Sexe...</option>
            <option value="Homme">Homme</option>
            <option value="Femme">Femme</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        <div class="form-group">
          <label>Photo de Profil :</label>
          <img
            id="preview-avatar"
            src="https://via.placeholder.com/80?text=?"
            alt="Aper√ßu"
          />
          <input
            type="file"
            id="file-input"
            accept="image/*"
            onchange="previewFile('register')"
            style="display: none"
          />
          <button
            onclick="document.getElementById('file-input').click()"
            class="btn-sec"
            style="
              font-size: 0.8em;
              padding: 5px;
              color: white;
              border: 1px solid #666;
            "
          >
            Uploader une photo
          </button>
          <div style="margin: 10px 0; font-size: 0.8em">Ou choisir :</div>
          <div class="avatar-grid">
            <img
              src="https://api.dicebear.com/7.x/adventurer/svg?seed=Felix"
              class="avatar-option"
              onclick="selectAvatar(this.src, 'register')"
            />
            <img
              src="https://api.dicebear.com/7.x/adventurer/svg?seed=Aneka"
              class="avatar-option"
              onclick="selectAvatar(this.src, 'register')"
            />
            <img
              src="https://api.dicebear.com/7.x/adventurer/svg?seed=Coco"
              class="avatar-option"
              onclick="selectAvatar(this.src, 'register')"
            />
            <img
              src="https://api.dicebear.com/7.x/adventurer/svg?seed=Jack"
              class="avatar-option"
              onclick="selectAvatar(this.src, 'register')"
            />
          </div>
        </div>
        <button onclick="register()" class="btn-main">VALIDER</button>
        <button
          onclick="toggleAuth(false)"
          class="btn-sec"
          style="margin-top: 10px"
        >
          Retour
        </button>
        <p
          id="reg-err"
          style="color: #ff4444; font-size: 0.8em; margin-top: 15px"
        ></p>
      </div>
    </div>

    <!-- MODIFIER PROFIL -->
    <div id="edit-profile-modal" class="modal-overlay" style="display: none">
      <div class="auth-container">
        <h2 style="color: var(--secondary)">Modifier mon Profil</h2>
        <div class="form-group">
          <label>Nouvelle Photo :</label
          ><img id="edit-preview-avatar" src="" /><input
            type="file"
            id="edit-file-input"
            accept="image/*"
            onchange="previewFile('edit')"
            style="display: none"
          /><button
            onclick="document.getElementById('edit-file-input').click()"
            class="btn-sec"
            style="font-size: 0.8em; padding: 5px"
          >
            Changer la photo
          </button>
        </div>
        <div class="form-group">
          <label>Nouveau Statut</label
          ><input id="edit-status" placeholder="Votre humeur..." />
        </div>
        <div class="form-group">
          <label>Nouveau Mot de Passe</label
          ><input
            id="edit-password"
            type="password"
            placeholder="Laisser vide si inchang√©"
          />
        </div>
        <button onclick="saveProfile()" class="btn-main">ENREGISTRER</button>
        <button
          onclick="document.getElementById('edit-profile-modal').style.display='none'"
          class="btn-sec"
          style="margin-top: 10px"
        >
          Annuler
        </button>
      </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-overlay" style="display: none">
      <div class="auth-container">
        <h2 style="color: var(--primary)">
          <i class="fas fa-palette"></i> Options
        </h2>
        <div class="form-group">
          <label>Th√®me du site :</label>
          <div style="display: flex; gap: 10px; margin-top: 5px">
            <button
              onclick="changeThemeMode('dark')"
              class="btn-sec"
              style="flex: 1"
            >
              üåô Sombre
            </button>
            <button
              onclick="changeThemeMode('light')"
              class="btn-main"
              style="flex: 1; background: #ddd; color: black"
            >
              ‚òÄÔ∏è Clair
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Image de fond du Chat :</label>
          <div style="display: flex; gap: 10px; margin-top: 5px">
            <button
              onclick="document.getElementById('bg-file-input').click()"
              class="btn-blue"
              style="flex: 1"
            >
              Choisir...
            </button>
            <button onclick="resetBg()" class="btn-grey" style="flex: 1">
              Par d√©faut
            </button>
          </div>
          <input
            type="file"
            id="bg-file-input"
            accept="image/*"
            onchange="previewBg()"
            style="display: none"
          />
        </div>
        <div class="form-group">
          <label>Luminosit√© du fond :</label>
          <input
            type="range"
            id="opacity-slider"
            min="0"
            max="0.95"
            step="0.05"
            oninput="changeOpacity(this.value)"
          />
        </div>
        <div
          class="form-group"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <label>Couleur de MES messages :</label
          ><input
            type="color"
            id="color-me"
            value="#ff7b00"
            style="width: 50px"
          />
        </div>
        <div
          class="form-group"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <label>Couleur des AUTRES messages :</label
          ><input
            type="color"
            id="color-other"
            value="#333333"
            style="width: 50px"
          />
        </div>
        <button
          onclick="saveSettings()"
          class="btn-main"
          style="margin-top: 20px"
        >
          SAUVEGARDER
        </button>
        <button
          onclick="document.getElementById('settings-modal').style.display='none'"
          class="btn-sec"
          style="margin-top: 10px"
        >
          Fermer
        </button>
      </div>
    </div>

    <!-- PROFIL VIEW -->
    <div id="profile-modal" class="modal-overlay" style="display: none">
      <div class="card">
        <button
          onclick="document.getElementById('profile-modal').style.display='none'"
          style="
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            color: #aaa;
            font-size: 1.2em;
            border: none;
            padding: 0;
          "
        >
          <i class="fas fa-times"></i>
        </button>
        <img id="prof-img" class="profile-pic-big" src="" />
        <h2 id="prof-name" style="margin: 0; color: white">Pseudo</h2>
        <div class="profile-info">
          <div id="prof-details"></div>
          <div
            id="prof-status"
            style="color: var(--secondary); font-style: italic"
          ></div>
          <div id="prof-date" style="font-size: 0.8em; opacity: 0.7"></div>
        </div>
        <div
          id="prof-actions"
          style="display: flex; gap: 10px; flex-direction: column"
        ></div>
      </div>
    </div>

    <!-- APPEL -->
    <div id="call-modal" class="modal-overlay" style="display: none">
      <div class="card">
        <h2 style="color: var(--secondary)">Appel Entrant...</h2>
        <h3 id="caller-name">Utilisateur</h3>
        <div style="display: flex; gap: 10px; justify-content: center">
          <button
            onclick="acceptCall()"
            class="btn-main"
            style="background: #00ff88; color: black"
          >
            R√©pondre
          </button>
          <button
            onclick="rejectCall()"
            class="btn-main"
            style="background: #ff4444"
          >
            Refuser
          </button>
        </div>
      </div>
    </div>

    <div id="app">
      <div id="sidebar">
        <div id="sidebar-content">
          <div class="radio-player">
            <div
              style="
                color: var(--primary);
                font-size: 0.9em;
                margin-bottom: 5px;
              "
            >
              RADIO MUSI-SPORTS
            </div>
            <audio
              id="radio-stream"
              controls
              src="https://stream.zeno.fm/s49326z7y18uv"
              style="width: 100%"
            ></audio>
          </div>
          <div id="friend-requests">
            <div
              style="
                font-weight: bold;
                font-size: 0.9em;
                color: var(--secondary);
                margin-bottom: 10px;
              "
            >
              üîî DEMANDES
            </div>
            <div id="requests-list"></div>
          </div>
          <div class="section-title">MES AMIS</div>
          <div id="friends-list"></div>
          <div class="section-title">TOUT LE MONDE</div>
          <div id="users-list"></div>
        </div>
        <div id="sidebar-footer">
          <button
            onclick="document.getElementById('settings-modal').style.display='flex'"
            class="btn-main"
            style="background: #9b59b6; width: 100%"
          >
            <i class="fas fa-palette"></i> OPTIONS
          </button>
          <button
            onclick="openEditProfile()"
            class="btn-blue"
            style="width: 100%"
          >
            <i class="fas fa-cog"></i> MON COMPTE
          </button>
          <button
            onclick="location.reload()"
            class="btn-main"
            style="
              width: 100%;
              background: rgba(255, 68, 68, 0.1);
              border: 1px solid #ff4444;
              color: #ff4444;
            "
          >
            D√âCONNEXION
          </button>
        </div>
      </div>

      <div id="chat-area">
        <div id="messages"></div>
        <div class="main-input-zone">
          <emoji-picker id="emoji-picker"></emoji-picker>
          <input id="m" placeholder="Message public..." />
          <button class="icon-btn" onclick="toggleEmojiPicker()" title="Emoji">
            üòÄ
          </button>
          <input
            type="file"
            id="img-upload-public"
            accept="image/*"
            style="display: none"
            onchange="sendImage('public')"
          />
          <button
            class="icon-btn"
            onclick="document.getElementById('img-upload-public').click()"
            title="Image"
          >
            <i class="fas fa-image"></i>
          </button>
          <button
            onclick="send()"
            class="btn-main"
            style="width: 50px; border-radius: 50%"
          >
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
    <div id="private-area"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let myName = "",
        myAvatar = "",
        myStatus = "";
      let history = [],
        onlineUsers = [],
        myFriends = [],
        myRequests = [],
        avatarsMap = {},
        statusesMap = {},
        myUnread = {};
      let isAdmin = false;
      let mediaRecorders = {},
        audioChunks = {};
      let localStream, peerConnection, activeCallUser;
      const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
      const notifSound = document.getElementById("notif-sound");

      function openImage(src) {
        document.getElementById("lightbox-img").src = src;
        document.getElementById("lightbox").style.display = "flex";
      }
      function closeImage() {
        document.getElementById("lightbox").style.display = "none";
      }

      const picker = document.querySelector("emoji-picker");
      function toggleEmojiPicker() {
        picker.classList.toggle("show");
      }
      picker.addEventListener("emoji-click", (event) => {
        const i = document.getElementById("m");
        i.value += event.detail.unicode;
        picker.classList.remove("show");
        i.focus();
      });

      let tempBgBase64 = "",
        currentTheme = "dark";
      function previewBg() {
        const f = document.getElementById("bg-file-input").files[0];
        const r = new FileReader();
        r.onloadend = () => {
          tempBgBase64 = r.result;
          applyTheme({ chatBg: r.result });
        };
        if (f) r.readAsDataURL(f);
      }
      function resetBg() {
        tempBgBase64 = "DEFAULT";
        document.documentElement.style.setProperty(
          "--chat-bg-image",
          "url('background.jpg')"
        );
      }
      function changeOpacity(val) {
        document.documentElement.style.setProperty("--overlay-opacity", val);
      }
      function changeThemeMode(mode) {
        currentTheme = mode;
        if (mode === "light") {
          document.documentElement.style.setProperty("--bg-color", "#f0f2f5");
          document.documentElement.style.setProperty(
            "--panel-bg",
            "rgba(255,255,255,0.95)"
          );
          document.documentElement.style.setProperty("--text-color", "#000000");
          document.documentElement.style.setProperty("--input-bg", "#ffffff");
        } else {
          document.documentElement.style.setProperty("--bg-color", "#0a0e17");
          document.documentElement.style.setProperty(
            "--panel-bg",
            "rgba(0,0,0,0.8)"
          );
          document.documentElement.style.setProperty("--text-color", "#ffffff");
          document.documentElement.style.setProperty(
            "--input-bg",
            "rgba(0,0,0,0.3)"
          );
        }
      }
      function saveSettings() {
        const ns = {
          chatBg: tempBgBase64,
          colorMe: document.getElementById("color-me").value,
          colorOther: document.getElementById("color-other").value,
          theme: currentTheme,
          opacity: document.getElementById("opacity-slider").value,
        };
        socket.emit("save-settings", ns);
        document.getElementById("settings-modal").style.display = "none";
      }
      function applyTheme(s) {
        const r = document.documentElement;
        if (s.colorMe) r.style.setProperty("--my-msg-bg", s.colorMe);
        if (s.colorOther) r.style.setProperty("--other-msg-bg", s.colorOther);
        if (s.chatBg)
          r.style.setProperty("--chat-bg-image", `url(${s.chatBg})`);
        if (s.opacity) {
          r.style.setProperty("--overlay-opacity", s.opacity);
          document.getElementById("opacity-slider").value = s.opacity;
        }
        if (s.theme) changeThemeMode(s.theme);
      }

      let selectedAvatarBase64 = "https://via.placeholder.com/80?text=User",
        editAvatarBase64 = "";
      function toggleAuth(s) {
        document.getElementById("login-form").style.display = s
          ? "none"
          : "block";
        document.getElementById("register-form").style.display = s
          ? "block"
          : "none";
      }
      function selectAvatar(u, m) {
        if (m === "register") {
          selectedAvatarBase64 = u;
          document.getElementById("preview-avatar").src = u;
        }
      }
      function previewFile(m) {
        const id = m === "register" ? "file-input" : "edit-file-input",
          imgId = m === "register" ? "preview-avatar" : "edit-preview-avatar";
        const f = document.getElementById(id).files[0];
        const r = new FileReader();
        r.onloadend = () => {
          if (m === "register") selectedAvatarBase64 = r.result;
          else editAvatarBase64 = r.result;
          document.getElementById(imgId).src = r.result;
        };
        if (f) r.readAsDataURL(f);
      }
      function register() {
        const p = document.getElementById("reg-u").value,
          pass = document.getElementById("reg-p").value,
          age = document.getElementById("reg-age").value,
          sex = document.getElementById("reg-sex").value;
        if (!p || !pass || !age || !sex)
          return (document.getElementById("reg-err").innerText =
            "Remplir tout");
        socket.emit("register", {
          pseudo: p,
          password: pass,
          age: age,
          sex: sex,
          avatar: selectedAvatarBase64,
        });
      }
      function login() {
        socket.emit("login", {
          pseudo: document.getElementById("login-u").value,
          password: document.getElementById("login-p").value,
        });
      }

      socket.on("auth-success", (data) => {
        myName = data.pseudo;
        myAvatar = data.avatar;
        myStatus = data.status;
        isAdmin = data.isAdmin;
        if (data.settings) applyTheme(data.settings);
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("app").style.display = "grid";
      });
      socket.on("auth-error", (m) => {
        document.getElementById("login-err").innerText = m;
        document.getElementById("reg-err").innerText = m;
      });
      socket.on("force-disconnect", () => {
        alert("Vous avez √©t√© banni.");
        location.reload();
      });
      socket.on("update-avatars", (map) => {
        avatarsMap = map;
        renderLists();
      });
      socket.on("update-statuses", (map) => {
        statusesMap = map;
        renderLists();
      });
      socket.on("update-unread", (data) => {
        myUnread = data;
        renderLists();
      });

      function openEditProfile() {
        document.getElementById("edit-status").value = myStatus || "Salut !";
        document.getElementById("edit-preview-avatar").src =
          myAvatar || "https://via.placeholder.com/80?text=?";
        editAvatarBase64 = myAvatar;
        document.getElementById("edit-profile-modal").style.display = "flex";
      }
      function saveProfile() {
        socket.emit("update-profile", {
          status: document.getElementById("edit-status").value,
          avatar: editAvatarBase64,
          password: document.getElementById("edit-password").value,
        });
        document.getElementById("edit-profile-modal").style.display = "none";
      }
      socket.on("profile-updated", (msg) => alert(msg));

      function send() {
        const i = document.getElementById("m");
        if (i.value) {
          socket.emit("chat message", { user: myName, text: i.value });
          i.value = "";
        }
      }
      document.getElementById("m").onkeypress = (e) => {
        if (e.key === "Enter") send();
      };
      function sendImage(target) {
        const f = document.getElementById(
          target === "public" ? "img-upload-public" : "img-upload-" + target
        ).files[0];
        const r = new FileReader();
        r.onloadend = () => {
          if (target === "public")
            socket.emit("chat message", {
              user: myName,
              image: r.result,
              type: "image",
            });
          else
            socket.emit("private-msg", {
              to: target,
              image: r.result,
              type: "image",
            });
        };
        if (f) r.readAsDataURL(f);
      }
      socket.on("chat message", (msg) => {
        history.push(msg);
        renderMsg(msg, "messages");
        if (msg.from !== myName) notifSound.play().catch(() => {});
      });
      socket.on("load-history", (msgs) => {
        history = msgs;
        document.getElementById("messages").innerHTML = "";
        msgs.forEach((m) => {
          if (m.to === "all") renderMsg(m, "messages");
        });
      });

      function renderMsg(m, divId) {
        const d = document.createElement("div");
        d.className = `msg ${m.from === myName ? "me" : "other"}`;
        const time = new Date(m.date).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        let content = m.content;
        if (m.type === "audio")
          content = `<audio controls src="${m.content}" class="audio-msg"></audio>`;
        if (m.type === "image")
          content = `<img src="${m.content}" class="img-msg" onclick="openImage(this.src)">`;
        let adminBtn = isAdmin
          ? `<div class="admin-del" onclick="if(confirm('Supprimer ?')) socket.emit('admin-delete-msg', '${m.id}')">X</div>`
          : "";
        d.innerHTML = `${adminBtn} <div class="msg-header"><span class="msg-name">${m.from}</span><span class="msg-time">${time}</span></div><div>${content}</div>`;
        const el = document.getElementById(divId);
        if (el) {
          el.appendChild(d);
          el.scrollTop = el.scrollHeight;
        }
      }

      socket.on("update-users", (u) => {
        onlineUsers = u;
        renderLists();
      });
      socket.on("update-friends", (d) => {
        myFriends = d.friends;
        myRequests = d.requests;
        renderLists();
      });
      socket.on("notification", (msg) => {
        alert("üîî " + msg);
        notifSound.play().catch(() => {});
      });

      function renderLists() {
        const reqList = document.getElementById("requests-list");
        document.getElementById("friend-requests").style.display =
          myRequests.length > 0 ? "block" : "none";
        reqList.innerHTML = "";
        myRequests.forEach((p) => {
          reqList.innerHTML += `<div class="req-item"><span>${p}</span><div class="req-actions"><button class="req-btn btn-main" onclick="respond('${p}',true)">‚úî</button><button class="req-btn btn-danger" onclick="respond('${p}',false)">‚úñ</button></div></div>`;
        });

        const fList = document.getElementById("friends-list");
        fList.innerHTML = "";
        if (myFriends.length === 0)
          fList.innerHTML =
            "<div style='opacity:0.5; font-size:0.8em; padding:10px'>Aucun ami</div>";
        myFriends.forEach((f) => {
          const pic = avatarsMap[f] || "https://via.placeholder.com/30?text=?";
          const st = statusesMap[f]
            ? `<span style="font-size:0.8em; color:#888; display:block; font-style:italic">"${statusesMap[f]}"</span>`
            : "";
          const isOnline = onlineUsers.includes(f);

          // BADGE LOGIC
          let count = myUnread[f] || 0;
          let badgeHtml =
            count > 0 ? `<span class="badge">${count}</span>` : "";

          const div = document.createElement("div");
          div.className = "user-item";
          div.innerHTML = `<img src="${pic}" class="user-avatar-small"> <div class="user-name-text">${f}${st}</div> ${badgeHtml} <div class="dot ${
            isOnline ? "online" : "offline"
          }"></div>`;
          div.onclick = () => openProfile(f);
          fList.appendChild(div);
        });

        const uList = document.getElementById("users-list");
        uList.innerHTML = "";
        onlineUsers.forEach((u) => {
          if (u !== myName && !myFriends.includes(u)) {
            const pic =
              avatarsMap[u] || "https://via.placeholder.com/30?text=?";
            const st = statusesMap[u]
              ? `<span style="font-size:0.8em; color:#888; display:block; font-style:italic">"${statusesMap[u]}"</span>`
              : "";

            let count = myUnread[u] || 0;
            let badgeHtml =
              count > 0 ? `<span class="badge">${count}</span>` : "";

            const div = document.createElement("div");
            div.className = "user-item";
            div.innerHTML = `<img src="${pic}" class="user-avatar-small"> <div class="user-name-text">${u}${st}</div> ${badgeHtml} <div class="dot online"></div>`;
            div.onclick = () => openProfile(u);
            uList.appendChild(div);
          }
        });
      }
      function respond(p, a) {
        socket.emit("respond-friend-request", { pseudo: p, accept: a });
      }

      function openProfile(user) {
        socket.emit("get-user-info", user);
      }
      socket.on("user-info-result", (i) => {
        document.getElementById("prof-img").src =
          i.avatar || "https://via.placeholder.com/100?text=?";
        document.getElementById("prof-name").innerText = i.pseudo;
        document.getElementById(
          "prof-details"
        ).innerText = `${i.age} ans ‚Ä¢ ${i.sex}`;
        document.getElementById("prof-status").innerText = i.status || "";
        document.getElementById("prof-date").innerText =
          "Inscrit le " + new Date(i.joinedAt).toLocaleDateString();
        const act = document.getElementById("prof-actions");
        act.innerHTML = "";
        if (isAdmin && i.pseudo !== myName) {
          act.innerHTML += `<button class="btn-danger" onclick="if(confirm('BANNIR ?')) socket.emit('admin-ban-user', '${i.pseudo}')">‚õî BANNIR (Admin)</button>`;
        }
        if (i.isBlocked) {
          act.innerHTML += `<button class="btn-main" onclick="socket.emit('unblock-user','${i.pseudo}');document.getElementById('profile-modal').style.display='none'">D√©bloquer</button>`;
        } else {
          if (i.isFriend) {
            const btnMsg = document.createElement("button");
            btnMsg.className = "btn-main";
            btnMsg.innerText = "Message Priv√©";
            btnMsg.setAttribute("onclick", `closeAndChat('${i.pseudo}')`);
            act.appendChild(btnMsg);
            act.innerHTML +=
              "<div style='color:#00ff88;margin:5px 0'>‚úÖ Ami</div>";
            const btnDel = document.createElement("button");
            btnDel.className = "btn-grey";
            btnDel.innerText = "Retirer des amis";
            btnDel.setAttribute(
              "onclick",
              `socket.emit('remove-friend', '${i.pseudo}'); document.getElementById('profile-modal').style.display='none';`
            );
            act.appendChild(btnDel);
          } else if (i.pseudo !== myName) {
            const btnAdd = document.createElement("button");
            btnAdd.className = "btn-blue";
            btnAdd.innerText = "Ajouter en ami";
            btnAdd.setAttribute("onclick", `sendRequest('${i.pseudo}')`);
            act.appendChild(btnAdd);
          }
          if (i.pseudo !== myName) {
            const btnBlk = document.createElement("button");
            btnBlk.className = "btn-danger";
            btnBlk.innerText = "Bloquer";
            btnBlk.style.marginTop = "10px";
            btnBlk.setAttribute(
              "onclick",
              `if(confirm('Bloquer ?')){ socket.emit('block-user', '${i.pseudo}'); document.getElementById('profile-modal').style.display='none'; }`
            );
            act.appendChild(btnBlk);
          }
        }
        document.getElementById("profile-modal").style.display = "flex";
      });

      function closeAndChat(user) {
        document.getElementById("profile-modal").style.display = "none";
        openPriv(user);
      }
      function sendRequest(user) {
        socket.emit("send-friend-request", user);
        document.getElementById("profile-modal").style.display = "none";
      }

      function openPriv(target) {
        // MARK AS READ
        socket.emit("mark-read", target);
        if (document.getElementById("win-" + target)) {
          document
            .getElementById("win-" + target)
            .classList.remove("minimized");
          return;
        }
        const w = document.createElement("div");
        w.id = "win-" + target;
        w.className = "win";
        w.innerHTML = `<div class="head"><span onclick="this.parentNode.parentNode.classList.toggle('minimized')">${target}</span> <div style="display:flex; gap:10px;"><span onclick="callUser('${target}')"><i class="fas fa-video"></i></span><span onclick="this.closest('.win').remove()"><i class="fas fa-times"></i></span></div></div><div class="body" id="body-${target}"></div><div class="private-input-zone"><input id="input-${target}" placeholder="Priv√©..." onkeypress="if(event.key==='Enter') sendPriv('${target}')"><input type="file" id="img-upload-${target}" accept="image/*" style="display:none" onchange="sendImage('${target}')"><button class="icon-btn" onclick="document.getElementById('img-upload-${target}').click()"><i class="fas fa-image"></i></button><button class="icon-btn" onclick="sendPriv('${target}')"><i class="fas fa-paper-plane"></i></button><button class="icon-btn" id="mic-${target}" onclick="rec('${target}')"><i class="fas fa-microphone"></i></button></div>`;
        document.getElementById("private-area").appendChild(w);
        history.forEach((m) => {
          if (
            (m.from == myName && m.to == target) ||
            (m.from == target && m.to == myName)
          )
            renderMsg(m, "body-" + target);
        });
      }
      function sendPriv(t) {
        const i = document.getElementById("input-" + t);
        if (i.value) {
          socket.emit("private-msg", { to: t, text: i.value, type: "text" });
          renderMsg(
            { from: myName, content: i.value, type: "text" },
            "body-" + t
          );
          i.value = "";
        }
      }
      async function rec(t) {
        const btn = document.getElementById(`mic-${t}`);
        if (!mediaRecorders[t] || mediaRecorders[t].state === "inactive") {
          try {
            const s = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            mediaRecorders[t] = new MediaRecorder(s);
            audioChunks[t] = [];
            mediaRecorders[t].ondataavailable = (e) =>
              audioChunks[t].push(e.data);
            mediaRecorders[t].onstop = () => {
              const b = new Blob(audioChunks[t], { type: "audio/webm" });
              const r = new FileReader();
              r.readAsDataURL(b);
              r.onloadend = () => {
                socket.emit("private-msg", {
                  to: t,
                  audioData: r.result,
                  type: "audio",
                });
                renderMsg(
                  { from: myName, content: r.result, type: "audio" },
                  "body-" + t
                );
              };
              s.getTracks().forEach((tr) => tr.stop());
            };
            mediaRecorders[t].start();
            btn.classList.add("recording");
          } catch (e) {
            alert("Micro inaccessible");
          }
        } else {
          mediaRecorders[t].stop();
          btn.classList.remove("recording");
        }
      }
      socket.on("private-msg", (m) => {
        history.push(m);
        if (document.getElementById("win-" + m.from))
          renderMsg(m, "body-" + m.from);
        if (m.from !== myName) notifSound.play().catch(() => {});
      });

      function toggleRadio(play) {
        const r = document.getElementById("radio-stream");
        if (r) play ? r.play().catch(() => {}) : r.pause();
      }
      async function callUser(u) {
        actCall = u;
        toggleRadio(false);
        try {
          ls = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          document.getElementById("video-overlay").style.display = "flex";
          document.getElementById("local-video").srcObject = ls;
          pc = new RTCPeerConnection(config);
          ls.getTracks().forEach((t) => pc.addTrack(t, ls));
          pc.onicecandidate = (e) => {
            if (e.candidate)
              socket.emit("ice-candidate", { to: u, candidate: e.candidate });
          };
          pc.ontrack = (e) => {
            document.getElementById("remote-video").srcObject = e.streams[0];
          };
          const off = await pc.createOffer();
          await pc.setLocalDescription(off);
          socket.emit("call-user", { offer: off, to: u });
        } catch (e) {
          alert("Cam√©ra inaccessible");
          toggleRadio(true);
          endCall();
        }
      }
      socket.on("call-made", async (d) => {
        actCall = d.from;
        document.getElementById("caller-name").innerText = d.from;
        document.getElementById("call-modal").style.display = "flex";
        pc = new RTCPeerConnection(config);
        pc.onicecandidate = (e) => {
          if (e.candidate)
            socket.emit("ice-candidate", {
              to: d.from,
              candidate: e.candidate,
            });
        };
        pc.ontrack = (e) => {
          document.getElementById("remote-video").srcObject = e.streams[0];
        };
        await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
        socket.dataOfferSocket = d.socket;
      });
      async function acceptCall() {
        document.getElementById("call-modal").style.display = "none";
        toggleRadio(false);
        document.getElementById("video-overlay").style.display = "flex";
        ls = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });
        document.getElementById("local-video").srcObject = ls;
        ls.getTracks().forEach((t) => pc.addTrack(t, ls));
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        socket.emit("make-answer", { answer: ans, to: actCall });
      }
      function rejectCall() {
        document.getElementById("call-modal").style.display = "none";
        socket.emit("hang-up", { to: actCall });
      }
      socket.on("answer-made", async (d) => {
        await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
      });
      socket.on("ice-candidate", async (d) => {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(d.candidate));
        } catch (e) {}
      });
      socket.on("hang-up", () => {
        endCall();
        alert("Appel termin√©");
      });
      function endCall() {
        document.getElementById("video-overlay").style.display = "none";
        if (pc) pc.close();
        if (ls) ls.getTracks().forEach((t) => t.stop());
        actCall = null;
        toggleRadio(true);
      }
      function toggleMic() {
        ls.getAudioTracks()[0].enabled = !ls.getAudioTracks()[0].enabled;
        event.currentTarget.classList.toggle("off");
      }
      function toggleCam() {
        ls.getVideoTracks()[0].enabled = !ls.getVideoTracks()[0].enabled;
        event.currentTarget.classList.toggle("off");
      }
    </script>
  </body>
</html>
