<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Mon Chat Moderne</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        background: #f0f2f5;
      }

      /* AUTH */
      #auth-screen {
        position: fixed;
        inset: 0;
        background: #2c3e50;
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .auth-box {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 300px;
        text-align: center;
      }
      .auth-box input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }

      /* SIDEBAR */
      #sidebar {
        width: 260px;
        background: #1a252f;
        color: white;
        display: none;
        flex-direction: column;
      }
      #user-list {
        list-style: none;
        padding: 0;
        margin: 0;
        flex: 1;
        overflow-y: auto;
      }
      #user-list li {
        padding: 15px;
        cursor: pointer;
        border-bottom: 1px solid #2c3e50;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #user-list li:hover {
        background: #34495e;
      }
      .notification-badge {
        background: #ff3b30;
        color: white;
        border-radius: 50%;
        padding: 2px 8px;
        font-size: 0.8em;
        font-weight: bold;
      }
      .logout-btn {
        padding: 15px;
        background: #c0392b;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      /* MAIN CHAT */
      #main-chat {
        flex: 1;
        display: none;
        flex-direction: column;
        background: white;
      }
      #main-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        background-image: url("fond.jpg");
        background-size: cover;
        background-position: center;
      }
      .msg {
        margin-bottom: 10px;
        padding: 10px 15px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.95);
        max-width: 70%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .my-msg {
        background: #dcf8c6 !important;
        align-self: flex-end;
      }
      .time {
        font-size: 0.7em;
        color: #888;
        float: right;
        margin-top: 5px;
        margin-left: 10px;
      }

      /* PRIVATE WINDOWS */
      #private-container {
        position: fixed;
        bottom: 0;
        right: 20px;
        display: flex;
        align-items: flex-end;
        gap: 10px;
        pointer-events: none;
      }
      .chat-window {
        width: 280px;
        height: 350px;
        background: white;
        border-radius: 10px 10px 0 0;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        transition: height 0.3s;
      }
      .chat-header {
        background: #0084ff;
        color: white;
        padding: 10px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        border-radius: 10px 10px 0 0;
      }
      .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        font-size: 0.85em;
      }
      .chat-window input {
        border: none;
        border-top: 1px solid #eee;
        padding: 10px;
        outline: none;
      }
      .minimized {
        height: 40px !important;
      }
      .minimized .chat-body,
      .minimized input {
        display: none;
      }

      /* MODAL INFO */
      #info-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 3000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 280px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="info-modal">
      <div class="modal-content">
        <h2 id="info-pseudo"></h2>
        <p id="info-date"></p>
        <button
          onclick="document.getElementById('info-modal').style.display='none'"
        >
          Fermer
        </button>
      </div>
    </div>

    <div id="auth-screen">
      <div class="auth-box">
        <h2>Chat Mondial</h2>
        <input id="p" placeholder="Pseudo" />
        <input id="m" type="password" placeholder="Mot de passe" />
        <button
          onclick="auth('login')"
          style="
            background: #0084ff;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          Connexion
        </button>
        <button
          onclick="auth('register')"
          style="
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
          "
        >
          S'inscrire
        </button>
        <p id="err" style="color: red; font-size: 0.8em; margin-top: 10px"></p>
      </div>
    </div>

    <div id="sidebar">
      <h3 style="padding: 15px; margin: 0; background: #121921">
        Utilisateurs
      </h3>
      <ul id="user-list"></ul>
      <button class="logout-btn" onclick="location.reload()">
        DÉCONNEXION
      </button>
    </div>

    <div id="main-chat">
      <div id="main-messages"></div>
      <div
        style="
          padding: 15px;
          display: flex;
          background: white;
          border-top: 1px solid #ddd;
        "
      >
        <input
          id="main-input"
          style="
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
          "
          placeholder="Message public..."
        />
        <button
          onclick="sendPublic()"
          style="
            margin-left: 10px;
            border: none;
            background: #0084ff;
            color: white;
            padding: 0 20px;
            border-radius: 20px;
            cursor: pointer;
          "
        >
          Envoyer
        </button>
      </div>
    </div>

    <div id="private-container"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let myPseudo = "";
      let fullHistory = [];
      let unreadCounts = {};
      let currentOnlineUsers = [];
      let typingTimeouts = {};

      function auth(type) {
        const pseudo = document.getElementById("p").value;
        const password = document.getElementById("m").value;
        if (pseudo && password) socket.emit(type, { pseudo, password });
      }

      socket.on("auth-success", (p) => {
        myPseudo = p;
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("sidebar").style.display = "flex";
        document.getElementById("main-chat").style.display = "flex";
      });

      socket.on("auth-error", (msg) => {
        document.getElementById("err").textContent = msg;
      });

      function formatTime(ts) {
        const d = new Date(ts);
        return (
          d.getHours().toString().padStart(2, "0") +
          ":" +
          d.getMinutes().toString().padStart(2, "0")
        );
      }

      // --- PUBLIC ---
      socket.on("load-history", (h) => {
        fullHistory = h;
        h.forEach((m) => {
          if (m.to === "all") displayPublicMsg(m);
        });
      });

      function sendPublic() {
        const i = document.getElementById("main-input");
        if (i.value) {
          socket.emit("chat message", { user: myPseudo, text: i.value });
          i.value = "";
        }
      }

      socket.on("chat message", (m) => {
        fullHistory.push(m);
        displayPublicMsg(m);
      });

      function displayPublicMsg(m) {
        const d = document.createElement("div");
        d.className = "msg" + (m.from === myPseudo ? " my-msg" : "");
        d.innerHTML = `<b>${m.from}:</b> ${
          m.text
        } <span class="time">${formatTime(m.date)}</span>`;
        document.getElementById("main-messages").appendChild(d);
        document.getElementById("main-messages").scrollTop = 999999;
      }

      // --- USERS & NOTIFS ---
      socket.on("update-users", (users) => {
        currentOnlineUsers = users;
        renderUserList();
      });

      function renderUserList() {
        const list = document.getElementById("user-list");
        list.innerHTML = "";
        currentOnlineUsers.forEach((u) => {
          if (u !== myPseudo) {
            const count = unreadCounts[u] || 0;
            const li = document.createElement("li");
            li.innerHTML = `<span>● ${u}</span> <span class="notification-badge" style="display:${
              count > 0 ? "block" : "none"
            }">${count}</span>`;
            li.onclick = () => openPrivateChat(u);
            li.oncontextmenu = (e) => {
              e.preventDefault();
              showUserInfo(u);
            };
            list.appendChild(li);
          }
        });
      }

      // --- PRIVATE ---
      function openPrivateChat(target) {
        unreadCounts[target] = 0;
        renderUserList();
        if (document.getElementById("chat-" + target)) {
          document
            .getElementById("chat-" + target)
            .classList.remove("minimized");
          return;
        }
        const win = document.createElement("div");
        win.id = "chat-" + target;
        win.className = "chat-window";
        win.innerHTML = `
                <div class="chat-header">
                    <div style="display:flex; flex-direction:column">
                        <span onclick="toggleMin('${target}')">${target}</span>
                        <small id="typing-${target}" style="font-size:0.7em; color:#dcf8c6; display:none;">écrit...</small>
                    </div>
                    <button onclick="document.getElementById('chat-${target}').remove()" style="background:none; border:none; color:white; cursor:pointer">X</button>
                </div>
                <div class="chat-body" id="body-${target}"></div>
                <input id="input-${target}" placeholder="Privé..." onkeypress="checkPrivate(event, '${target}')">
            `;
        document.getElementById("private-container").appendChild(win);
        fullHistory.forEach((m) => {
          if (
            (m.from === myPseudo && m.to === target) ||
            (m.from === target && m.to === myPseudo)
          ) {
            addPrivateMsgUI(target, m.from, m.text, m.date);
          }
        });
      }

      function checkPrivate(e, target) {
        socket.emit("typing", { to: target });
        if (e.key === "Enter") {
          const i = document.getElementById("input-" + target);
          if (i.value) {
            socket.emit("private-msg", { to: target, text: i.value });
            addPrivateMsgUI(target, "Moi", i.value, Date.now());
            i.value = "";
          }
        }
      }

      socket.on("private-msg", (m) => {
        fullHistory.push(m);
        const win = document.getElementById("chat-" + m.from);
        if (!win || win.classList.contains("minimized")) {
          unreadCounts[m.from] = (unreadCounts[m.from] || 0) + 1;
          renderUserList();
        }
        if (win) addPrivateMsgUI(m.from, m.from, m.text, m.date);
      });

      socket.on("is-typing", (d) => {
        const label = document.getElementById("typing-" + d.from);
        if (label) {
          label.style.display = "block";
          clearTimeout(typingTimeouts[d.from]);
          typingTimeouts[d.from] = setTimeout(() => {
            label.style.display = "none";
          }, 2000);
        }
      });

      function addPrivateMsgUI(winId, sender, text, date) {
        const b = document.getElementById("body-" + winId);
        if (b) {
          b.innerHTML += `<div><b>${sender}:</b> ${text} <small style="color:#999">(${formatTime(
            date
          )})</small></div>`;
          b.scrollTop = 999999;
        }
      }

      // --- UTILS ---
      function toggleMin(id) {
        const w = document.getElementById("chat-" + id);
        w.classList.toggle("minimized");
        if (!w.classList.contains("minimized")) {
          unreadCounts[id] = 0;
          renderUserList();
        }
      }
      function showUserInfo(pseudo) {
        socket.emit("get-user-info", pseudo);
        socket.on("user-info-result", (info) => {
          document.getElementById("info-pseudo").textContent = info.pseudo;
          document.getElementById("info-date").textContent =
            "Inscrit le : " + new Date(info.joinedAt).toLocaleDateString();
          document.getElementById("info-modal").style.display = "flex";
        });
      }
    </script>
  </body>
</html>
